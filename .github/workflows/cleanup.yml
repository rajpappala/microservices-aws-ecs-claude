name: Cleanup AWS Resources

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type DELETE to confirm cleanup'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  ENVIRONMENT_NAME: microservices-demo

jobs:
  cleanup:
    name: Delete AWS Resources
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Display Resources to be Deleted
        run: |
          echo "## ðŸ—‘ï¸ AWS Resources Teardown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Resources to be deleted:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Cluster and Services" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Application Load Balancer" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VPC and Networking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CloudWatch Logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ’° Monthly Cost Savings:** ~\$107-117" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Existing Resources
        run: |
          echo "ðŸ” Checking existing CloudFormation stacks..."

          # Check if infrastructure stack exists
          if aws cloudformation describe-stacks \
            --stack-name ${{ env.ENVIRONMENT_NAME }}-infra \
            --region ${{ env.AWS_REGION }} &>/dev/null; then
            echo "âœ“ Found: ${{ env.ENVIRONMENT_NAME }}-infra"
            INFRA_EXISTS=true
          else
            echo "â„¹ Stack not found: ${{ env.ENVIRONMENT_NAME }}-infra"
            INFRA_EXISTS=false
          fi

          # Check if ECR stack exists
          if aws cloudformation describe-stacks \
            --stack-name ${{ env.ENVIRONMENT_NAME }}-ecr \
            --region ${{ env.AWS_REGION }} &>/dev/null; then
            echo "âœ“ Found: ${{ env.ENVIRONMENT_NAME }}-ecr"
            ECR_EXISTS=true
          else
            echo "â„¹ Stack not found: ${{ env.ENVIRONMENT_NAME }}-ecr"
            ECR_EXISTS=false
          fi

          # Set outputs for next steps
          echo "INFRA_EXISTS=$INFRA_EXISTS" >> $GITHUB_ENV
          echo "ECR_EXISTS=$ECR_EXISTS" >> $GITHUB_ENV

      - name: "[1/5] Delete ECS Infrastructure Stack"
        run: |
          echo "### [1/5] Deleting ECS Infrastructure" >> $GITHUB_STEP_SUMMARY

          if [ "$INFRA_EXISTS" == "true" ]; then
            echo "ðŸ—‘ï¸ Deleting ECS infrastructure stack..."
            echo "   - Stopping ECS tasks..."
            echo "   - Deleting ECS services..."
            echo "   - Removing load balancer..."
            echo "   - Deleting VPC and networking..."

            aws cloudformation delete-stack \
              --stack-name ${{ env.ENVIRONMENT_NAME }}-infra \
              --region ${{ env.AWS_REGION }}

            echo "â³ Waiting for infrastructure stack deletion (5-10 minutes)..."

            if aws cloudformation wait stack-delete-complete \
              --stack-name ${{ env.ENVIRONMENT_NAME }}-infra \
              --region ${{ env.AWS_REGION }} 2>/dev/null; then
              echo "âœ… Infrastructure stack deleted successfully" >> $GITHUB_STEP_SUMMARY
              echo "âœ“ Infrastructure stack deleted successfully"
            else
              echo "âš ï¸ Infrastructure stack deletion completed with warnings" >> $GITHUB_STEP_SUMMARY
              echo "âš  Stack deletion completed with warnings"
            fi
          else
            echo "â„¹ï¸ Infrastructure stack not found, skipping" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ Infrastructure stack not found, skipping"
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "[2/5] Delete Service 1 Docker Images"
        run: |
          echo "### [2/5] Deleting Service 1 Images" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—‘ï¸ Deleting Docker images from Service 1 repository..."

          # Get all images
          IMAGES=$(aws ecr list-images \
            --repository-name ${{ env.ENVIRONMENT_NAME }}/service1 \
            --region ${{ env.AWS_REGION }} \
            --query 'imageIds[*]' \
            --output json 2>/dev/null || echo "[]")

          if [ "$IMAGES" != "[]" ]; then
            aws ecr batch-delete-image \
              --repository-name ${{ env.ENVIRONMENT_NAME }}/service1 \
              --image-ids "$IMAGES" \
              --region ${{ env.AWS_REGION }} &>/dev/null && \
              echo "âœ… Service 1 images deleted" >> $GITHUB_STEP_SUMMARY || \
              echo "âš ï¸ Service 1 repository not found" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Service 1 images deleted"
          else
            echo "â„¹ï¸ Service 1 repository empty or not found" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ Service 1 repository empty or not found"
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "[3/5] Delete Service 2 Docker Images"
        run: |
          echo "### [3/5] Deleting Service 2 Images" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—‘ï¸ Deleting Docker images from Service 2 repository..."

          # Get all images
          IMAGES=$(aws ecr list-images \
            --repository-name ${{ env.ENVIRONMENT_NAME }}/service2 \
            --region ${{ env.AWS_REGION }} \
            --query 'imageIds[*]' \
            --output json 2>/dev/null || echo "[]")

          if [ "$IMAGES" != "[]" ]; then
            aws ecr batch-delete-image \
              --repository-name ${{ env.ENVIRONMENT_NAME }}/service2 \
              --image-ids "$IMAGES" \
              --region ${{ env.AWS_REGION }} &>/dev/null && \
              echo "âœ… Service 2 images deleted" >> $GITHUB_STEP_SUMMARY || \
              echo "âš ï¸ Service 2 repository not found" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Service 2 images deleted"
          else
            echo "â„¹ï¸ Service 2 repository empty or not found" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ Service 2 repository empty or not found"
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "[4/5] Delete ECR Repositories Stack"
        run: |
          echo "### [4/5] Deleting ECR Repositories" >> $GITHUB_STEP_SUMMARY

          if [ "$ECR_EXISTS" == "true" ]; then
            echo "ðŸ—‘ï¸ Deleting ECR repositories stack..."

            aws cloudformation delete-stack \
              --stack-name ${{ env.ENVIRONMENT_NAME }}-ecr \
              --region ${{ env.AWS_REGION }}

            echo "â³ Waiting for ECR stack deletion..."

            if aws cloudformation wait stack-delete-complete \
              --stack-name ${{ env.ENVIRONMENT_NAME }}-ecr \
              --region ${{ env.AWS_REGION }} 2>/dev/null; then
              echo "âœ… ECR repositories deleted successfully" >> $GITHUB_STEP_SUMMARY
              echo "âœ“ ECR repositories deleted successfully"
            else
              echo "âš ï¸ ECR stack deletion completed with warnings" >> $GITHUB_STEP_SUMMARY
              echo "âš  ECR stack deletion completed with warnings"
            fi
          else
            echo "â„¹ï¸ ECR repositories stack not found, skipping" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ ECR repositories stack not found, skipping"
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "[5/5] Verify Cleanup"
        run: |
          echo "### [5/5] Verification" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Verifying all resources deleted..."

          REMAINING=$(aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --region ${{ env.AWS_REGION }} \
            --query "StackSummaries[?contains(StackName, '${{ env.ENVIRONMENT_NAME }}')].StackName" \
            --output text 2>/dev/null || echo "")

          if [ -z "$REMAINING" ]; then
            echo "âœ… All stacks deleted successfully" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ All stacks deleted successfully"
          else
            echo "âš ï¸ Some stacks still exist: $REMAINING" >> $GITHUB_STEP_SUMMARY
            echo "âš  Some stacks still exist: $REMAINING"
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup Summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Cleanup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ ECS Cluster: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ Load Balancer: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ VPC & Networking: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ ECR Repositories: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ Docker Images: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—‘ï¸ CloudWatch Logs: Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ’° Monthly cost savings: ~\$107-117**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ Note: CloudWatch Logs may take a few hours to fully delete." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ To redeploy: Push a commit to trigger the deployment workflow" >> $GITHUB_STEP_SUMMARY
